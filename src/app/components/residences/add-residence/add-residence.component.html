<div class="container py-5">
  <h2 class="mb-4">Ajouter une nouvelle résidence</h2>
  
  <form [formGroup]="residenceForm" (ngSubmit)="onSubmit()" class="needs-validation" novalidate>
    <!-- Champ caché pour l'ID -->
    <input type="hidden" formControlName="id">
    
    <div class="row g-3">
      <!-- Nom -->
      <div class="col-md-6">
        <label for="name" class="form-label">Nom de la résidence</label>
        <input 
          type="text" 
          id="name" 
          class="form-control" 
          formControlName="name"
          [ngClass]="{ 'is-invalid': residenceForm.get('name')?.invalid && (residenceForm.get('name')?.dirty || residenceForm.get('name')?.touched) }"
        >
        <div class="invalid-feedback">
          <span *ngIf="residenceForm.get('name')?.hasError('required')">Ce champ est obligatoire</span>
          <span *ngIf="residenceForm.get('name')?.hasError('minlength')">Minimum 3 caractères</span>
        </div>
      </div>

      <!-- Adresse -->
      <div class="col-md-6">
        <label for="address" class="form-label">Adresse</label>
        <input 
          type="text" 
          id="address" 
          class="form-control" 
          formControlName="address"
          [ngClass]="{ 'is-invalid': residenceForm.get('address')?.invalid && (residenceForm.get('address')?.dirty || residenceForm.get('address')?.touched) }"
        >
        <div class="invalid-feedback">
          <span *ngIf="residenceForm.get('address')?.hasError('required')">Ce champ est obligatoire</span>
        </div>
      </div>

      <!-- Image -->
      <div class="col-md-6">
        <label for="image" class="form-label">URL de l'image</label>
        <input 
          type="text" 
          id="image" 
          class="form-control" 
          formControlName="image"
          [ngClass]="{ 'is-invalid': residenceForm.get('image')?.invalid && (residenceForm.get('image')?.dirty || residenceForm.get('image')?.touched) }"
        >
        <div class="invalid-feedback">
          <span *ngIf="residenceForm.get('image')?.hasError('required')">Ce champ est obligatoire</span>
          <span *ngIf="residenceForm.get('image')?.hasError('invalidUrl')">URL invalide</span>
        </div>
      </div>

      <!-- Statut -->
      <div class="col-md-6">
        <label for="status" class="form-label">Statut</label>
        <select 
          id="status" 
          class="form-select" 
          formControlName="status"
          [ngClass]="{ 'is-invalid': residenceForm.get('status')?.invalid && (residenceForm.get('status')?.dirty || residenceForm.get('status')?.touched) }"
        >
          <option *ngFor="let status of statusOptions" [value]="status">{{status}}</option>
        </select>
        <div class="invalid-feedback">
          <span *ngIf="residenceForm.get('status')?.hasError('required')">Ce champ est obligatoire</span>
        </div>
      </div>
    </div>

    <!-- Section des appartements -->
    <div class="mt-5">
      <h3 class="mb-4">Appartements</h3>
      
      <div formArrayName="apartments">
        <div *ngFor="let apartment of apartments.controls; let i = index" [formGroupName]="i" class="card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="h5 mb-0">Appartement #{{i + 1}}</h4>
            <button type="button" class="btn btn-sm btn-danger" (click)="removeApartment(i)">
              <i class="bi bi-trash"></i> Supprimer
            </button>
          </div>
          
          <div class="card-body">
            <div class="row g-3">
              <!-- Numéro d'appartement -->
              <div class="col-md-3">
                <label [for]="'apartNum' + i" class="form-label">Numéro d'appartement</label>
                <input 
                  type="text" 
                  [id]="'apartNum' + i" 
                  class="form-control" 
                  formControlName="apartNum"
                  [ngClass]="{ 'is-invalid': apartment.get('apartNum')?.invalid && (apartment.get('apartNum')?.dirty || apartment.get('apartNum')?.touched) }"
                >
                <div class="invalid-feedback">
                  <span *ngIf="apartment.get('apartNum')?.hasError('required')">Obligatoire</span>
                  <span *ngIf="apartment.get('apartNum')?.hasError('notNumber')">Nombre uniquement</span>
                </div>
              </div>

              <!-- Numéro d'étage -->
              <div class="col-md-3">
                <label [for]="'floorNum' + i" class="form-label">Numéro d'étage</label>
                <input 
                  type="text" 
                  [id]="'floorNum' + i" 
                  class="form-control" 
                  formControlName="floorNum"
                  [ngClass]="{ 'is-invalid': apartment.get('floorNum')?.invalid && (apartment.get('floorNum')?.dirty || apartment.get('floorNum')?.touched) }"
                >
                <div class="invalid-feedback">
                  <span *ngIf="apartment.get('floorNum')?.hasError('required')">Obligatoire</span>
                  <span *ngIf="apartment.get('floorNum')?.hasError('notNumber')">Nombre uniquement</span>
                </div>
              </div>

              <!-- Surface -->
              <div class="col-md-3">
                <label [for]="'surface' + i" class="form-label">Surface (m²)</label>
                <input 
                  type="number" 
                  [id]="'surface' + i" 
                  class="form-control" 
                  formControlName="surface"
                  [ngClass]="{ 'is-invalid': apartment.get('surface')?.invalid && (apartment.get('surface')?.dirty || apartment.get('surface')?.touched) }"
                >
                <div class="invalid-feedback">
                  <span *ngIf="apartment.get('surface')?.hasError('required')">Obligatoire</span>
                </div>
              </div>

              <!-- Catégorie -->
              <div class="col-md-3">
                <label [for]="'category' + i" class="form-label">Catégorie</label>
                <select 
                  [id]="'category' + i" 
                  class="form-select" 
                  formControlName="category"
                  [ngClass]="{ 'is-invalid': apartment.get('category')?.invalid && (apartment.get('category')?.dirty || apartment.get('category')?.touched) }"
                >
                  <option value="">Sélectionner</option>
                  <option value="S+1">S+1</option>
                  <option value="S+2">S+2</option>
                  <option value="S+3">S+3</option>
                </select>
                <div class="invalid-feedback">
                  <span *ngIf="apartment.get('category')?.hasError('required')">Obligatoire</span>
                </div>
              </div>

              <!-- Terrasse -->
              <div class="col-md-3">
                <div class="form-check mt-4">
                  <input 
                    class="form-check-input" 
                    type="checkbox" 
                    [id]="'terrace' + i" 
                    formControlName="terrace"
                  >
                  <label class="form-check-label" [for]="'terrace' + i">
                    Terrasse
                  </label>
                </div>
              </div>

              <!-- Surface de la terrasse (conditionnelle) -->
              <div class="col-md-3" *ngIf="apartment.get('terrace')?.value">
                <label [for]="'surfaceTerrace' + i" class="form-label">Surface terrasse (m²)</label>
                <input 
                  type="number" 
                  [id]="'surfaceTerrace' + i" 
                  class="form-control" 
                  formControlName="surfaceTerrace"
                >
              </div>
            </div>
          </div>
        </div>
      </div>

      <button type="button" class="btn btn-secondary mt-3" (click)="addApartment()">
        <i class="bi bi-plus-circle"></i> Ajouter un autre appartement
      </button>
    </div>

    <!-- Bouton de soumission -->
    <div class="mt-5">
      <button 
        type="submit" 
        class="btn btn-realestate btn-lg"
        [disabled]="residenceForm.invalid"
      >
        Ajouter la résidence
      </button>
    </div>
  </form>
</div>